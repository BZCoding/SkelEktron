<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Application Info</title>
    <link rel="stylesheet" href="assets/css/app.css">
    <script>
      const pjson = require('./package.json')
      const electron = require('electron')
      const ipc = require('electron').ipcRenderer

      // Request printer list on load
      window.addEventListener('load', () => {
        window.printers = []
        ipc.send('list-printers')
      })

      // Send printer events
      function printTXTTest(i) {
        console.log("Printing TXT test on", window.printers[i].name)
        ipc.send('print-txt-test', window.printers[i])
      }

      function printPDFTest(i) {
        console.log("Printing PDF test on", window.printers[i].name)
        ipc.send('print-pdf-test', window.printers[i])
      }

      // Manage printer events
      ipc.on('printing-error', (event, error) => {
        console.log('Printing Error: ', error)
        window.alert('Error while printing, see log for details')
      })

      ipc.on('printing-success', (event) => {
        console.log('Printing Complete')
        window.alert('Printing Complete')
      })

      // Display printer list
      ipc.on('printer-list', (event, printers) => {
        var html = '<p>No printers found.</p>'
        if (printers.length > 0) {
          window.printers = printers
          html = '<ul>'
          printers.forEach(function (device, i) {
            var isDefault = (device.isDefault) ? ' <small>(default)</small>' : ''
            var deviceName = (device.options && device.options['printer-info'])? device.options['printer-info'] : device.name
            var buttons = `<button onclick="printTXTTest(${i})">Print TXT Test</button>&nbsp;<button onclick="printPDFTest(${i})">Print PDF Test</button>`
            if (process.platform === 'win32') {
              buttons = ''
            }
            html += `<li>${deviceName}${isDefault} ${buttons}</li>`
          })
          html += '</ul>'
        }
        document.getElementById('printers').innerHTML = html
      })
    </script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1><script>document.write(electron.remote.app.getName())</script></h1>
        <h2>Version <script>document.write(pjson.version)</script></h2>
      </header>
      <section class="main">
        <ul>
          <li><strong>Platform</strong>: <script>document.write(process.platform)</script></li>
          <li><strong>Architecture</strong>: <script>document.write(process.arch)</script></li>
          <li><strong>OS Release</strong>: <script>document.write(require('os').release())</script></li>
          <li><strong>Main URL</strong>: <script>document.write(pjson.config.url || 'N.A.')</script></li>
          <li><strong>Updates URL</strong>: <script>document.write((pjson.config.update && pjson.config.update.url) ? pjson.config.update.url : 'N.A.')</script></li>
          <li><strong>Node</strong>: <script>document.write(process.versions.node)</script></li>
          <li><strong>Chrome</strong>: <script>document.write(process.versions.chrome)</script></li>
          <li><strong>Electron Runtime</strong>: <script>document.write(process.versions.electron)</script></li>
          <li><strong>Process ID</strong>: <script>document.write(process.pid)</script></li>
          <li><strong>Memory Usage</strong>: <script>document.write((Math.floor(process.memoryUsage().rss / (1024 * 1024))) + ' MB')</script></li>
          <li><strong>Debug Mode</strong>: <script>document.write(pjson.config.debug || false)</script></li>
        </ul>
      </section>
      <section class="printers">
        <h2>Available Printers</h2>
        <div id="printers">
          <p>Searching for printers...</p>
        </div>
      </section>
      <footer>
        <p>
          <small>(cc) 2016 SkelEktron</small>
        </p>
      </footer>
      <p><a id="close" href="javascript:window.close()">Close</a></p>
    </div>
  </body>
  <script>
    // You can also require other files to run in this process
    require('./assets/js/ex-links.js')
  </script>
</html>
